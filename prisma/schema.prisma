generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Aluno {
  id           String   @id @default(cuid())
  nomeCompleto String   @map("nome_completo")
  telefone     String?
  pais         String?
  email        String?
  profissao    String?  @map("profissao")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("alunos")
}

model CourseLead {
  id           String   @id @default(cuid())
  nomeCompleto String   @map("nome_completo")
  telefone     String?
  pais         String?
  email        String?
  origem       String   @default("formulario online")
  nota         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("course_leads")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  name                String
  companyName         String?
  role                String               @default("admin")
  isApproved          Boolean              @default(false)
  isAdmin             Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  apiKey              String               @unique @default(uuid())
  anamnesisRecords    AnamnesisRecord[]
  appointments        Appointment[]
  campaigns           Campaign[]
  clients             Client[]
  evolutionInstances  EvolutionInstance[]
  funnelEvents        FunnelEvent[]
  googleAccount       GoogleAccount?
  googleOAuthStates   GoogleOAuthState[]
  leads               Lead[]
  paypalAccount       PaypalAccount?
  paypalOAuthStates   PaypalOAuthState[]
  paypalTransactions  PaypalTransaction[]
  alunos              Aluno[]
  courseLeads         CourseLead[]
  sellers             Seller[]
  legacyAgentPrompt   LegacyAgentPrompt?
  agentPrompts        AgentPrompt[]
  evolutionInstanceAgentPrompts EvolutionInstanceAgentPrompt[]
  evolutionInstancePromptAssignments EvolutionInstancePromptAssignment[]
  promptDispatchLogs  PromptDispatchLog[]
  webhookTokens       WebhookToken[]
  whatsappMessages    WhatsappMessage[]
  whatsappPhoneInstances WhatsappPhoneInstance[]
  webhooks            Webhook[]
  webhookConfigs      WebhookConfig[]
  botActionLogs       BotActionLog[]
  botButtons          BotButton[]
}

model Client {
  id                 String              @id @default(cuid())
  name               String
  email              String?
  phone              String?
  source             String?
  tags               String[]
  score              Int                 @default(0)
  status             ClientStatus        @default(NEW)
  notes              String?
  age                Int?
  country            String?
  birthDate          DateTime?
  language           String?
  anamnesisResponses Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  address            String?
  userId             String
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  funnelEvents       FunnelEvent[]
  paypalTransactions PaypalTransaction[]

  @@index([userId])
}

model EvolutionInstance {
  id                 String    @id @default(cuid())
  userId             String
  instanceId         String    @unique
  providerInstanceId String?   @unique
  status             String    @default("pending")
  connectedAt        DateTime?
  metadata           Json?
  agentPrompt        String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promptLinks        EvolutionInstanceAgentPrompt[]
  promptAssignments  EvolutionInstancePromptAssignment[]
  promptDispatchLogs PromptDispatchLog[]

  @@index([userId])
}

model AnamnesisRecord {
  id                         String    @id @default(cuid())
  name                       String
  age                        Int?
  country                    String?
  birthDate                  DateTime?
  language                   String?
  phone                      String?
  email                      String?
  previousAestheticTreatment Boolean?
  originalResponses          Json?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  interest                   String?
  userId                     String
  user                       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Lead {
  id           String        @id @default(cuid())
  source       String?
  notes        String?
  score        Int           @default(0)
  stage        LeadStage     @default(NOVO)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  contact      String?
  email        String?
  name         String?
  userId       String
  appointments Appointment[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsappMessages WhatsappMessage[]

  @@index([userId])
}

model Seller {
  id                    String   @id @default(cuid())
  name                  String
  email                 String   @unique
  password              String
  mustChangePassword    Boolean  @default(true) @map("must_change_password")
  contactNumber         String?  @map("contact_number")
  userId                String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordResetTokens   PasswordResetToken[]
  availabilitySlots     SellerAvailability[]

  @@index([userId])
  @@map("sellers")
}

model SellerAvailability {
  id        String   @id @default(cuid())
  sellerId  String
  day       WeekDay
  dayOfMonth Int?    @map("day_of_month")
  specificDate DateTime? @map("specific_date")
  startTime String
  endTime   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  seller    Seller   @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId, day])
  @@index([sellerId, dayOfMonth])
  @@map("seller_availability")
}

model LegacyAgentPrompt {
  userId String @id
  prompt String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("agent_prompts")
}

model AgentPrompt {
  id        String   @id @default(cuid())
  userId    String
  name      String?
  prompt    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  links     EvolutionInstanceAgentPrompt[]
  assignments EvolutionInstancePromptAssignment[]
  dispatchLogs PromptDispatchLog[]

  @@index([userId])
  @@map("agent_prompt_library")
}

model EvolutionInstanceAgentPrompt {
  id                String   @id @default(cuid())
  userId            String
  evolutionInstanceId String @map("evolution_instance_id")
  agentPromptId     String   @map("agent_prompt_id")
  percentBps        Int      @map("percent")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  evolutionInstance EvolutionInstance @relation(fields: [evolutionInstanceId], references: [id], onDelete: Cascade)
  agentPrompt       AgentPrompt     @relation(fields: [agentPromptId], references: [id], onDelete: Cascade)

  @@unique([evolutionInstanceId, agentPromptId])
  @@index([userId])
  @@index([evolutionInstanceId])
  @@map("evolution_instance_agent_prompts")
}

model EvolutionInstancePromptAssignment {
  id                 String   @id @default(cuid())
  userId             String
  evolutionInstanceId String  @map("evolution_instance_id")
  phoneRaw           String   @map("phone_raw")
  agentPromptId      String   @map("agent_prompt_id")
  assignedBy         String   @default("auto") @map("assigned_by")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  evolutionInstance  EvolutionInstance @relation(fields: [evolutionInstanceId], references: [id], onDelete: Cascade)
  agentPrompt        AgentPrompt      @relation(fields: [agentPromptId], references: [id], onDelete: Cascade)

  @@unique([evolutionInstanceId, phoneRaw])
  @@index([userId, phoneRaw])
  @@index([evolutionInstanceId])
  @@map("evolution_instance_prompt_assignments")
}

model WebhookToken {
  id        String   @id @default(cuid())
  token     String   @unique
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("webhook_tokens")
}

model WhatsappPhoneInstance {
  id                 String   @id @default(cuid())
  userId             String
  phoneRaw           String   @unique
  instanceId         String
  providerInstanceId String?
  slotId             String?
  webhookUrl         String?
  botStatus          BotStatus? @default(ATIVO)
  botTravarAt        DateTime?
  botPausarAt        DateTime?
  botReativarAt      DateTime?
  botWebhookConfigId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  botWebhookConfig   WebhookConfig? @relation(fields: [botWebhookConfigId], references: [id], onDelete: SetNull)
  botActionLogs      BotActionLog[]

  @@index([userId])
  @@map("whatsapp_phone_instance")
}

model BotActionLog {
  id               String   @id @default(cuid())
  userId           String
  phoneInstanceId  String
  action           String   // TRAVAR | PAUSAR | REATIVAR
  timestamp        DateTime @default(now())
  actorUserId      String?
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneInstance    WhatsappPhoneInstance @relation(fields: [phoneInstanceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phoneInstanceId, timestamp])
  @@map("bot_action_logs")
}

model WebhookConfig {
  id        String   @id @default(cuid())
  userId    String
  origin    String
  url       String
  headers   Json?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneInstances WhatsappPhoneInstance[]

  @@index([userId, origin])
  @@map("webhook_configs")
}

model BotButton {
  id        String   @id @default(cuid())
  userId    String
  name      String
  variable  String
  url       String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, variable])
  @@map("bot_buttons")
}

model Webhook {
  id                 String   @id @default(cuid())
  userId             String
  instanceId         String?
  providerInstanceId String?
  slotId             String?
  phoneRaw           String?
  receivedAt         DateTime @default(now())
  rawJson            Json?
  jsonrow            Json?
  outboundJson       Json?
  outboundUrl        String?
  status             String   @default("received")
  sentAt             DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  promptDispatchLogs PromptDispatchLog[]

  @@index([userId, receivedAt])
  @@index([phoneRaw])
  @@map("webhooks")
}

model PromptDispatchLog {
  id                 String   @id @default(cuid())
  userId             String
  evolutionInstanceId String  @map("evolution_instance_id")
  webhookId          String   @map("webhook_id")
  phoneRaw           String   @map("phone_raw")
  agentPromptId      String?  @map("agent_prompt_id")
  promptName         String?  @map("prompt_name")
  percentBps         Int?     @map("percent_bps")
  assignedBy         String   @map("assigned_by")
  wamid              String?
  occurredAt         DateTime @map("occurred_at")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  evolutionInstance  EvolutionInstance @relation(fields: [evolutionInstanceId], references: [id], onDelete: Cascade)
  webhook            Webhook          @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  agentPrompt        AgentPrompt?     @relation(fields: [agentPromptId], references: [id], onDelete: SetNull)

  @@index([userId, occurredAt])
  @@index([evolutionInstanceId, occurredAt])
  @@index([phoneRaw])
  @@map("agent_prompt_dispatch_logs")
}

model Appointment {
  id            String            @id @default(cuid())
  start         DateTime
  end           DateTime
  status        AppointmentStatus @default(AGENDADA)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  googleEventId String?
  leadId        String
  meetLink      String?
  userId        String
  lead          Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
}

model Campaign {
  id          String         @id @default(cuid())
  name        String
  channel     String
  message     String
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  imageUrl    String?
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs        CampaignLog[]

  @@index([userId])
}

model FunnelEvent {
  id        String   @id @default(cuid())
  clientId  String
  type      String
  meta      Json?
  createdAt DateTime @default(now())
  userId    String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
  @@index([type, createdAt])
}

model CampaignLog {
  id         String   @id @default(cuid())
  campaignId String
  message    String
  createdAt  DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model GoogleAccount {
  id           String    @id @default(cuid())
  userId       String    @unique
  googleUserId String?
  email        String?
  refreshToken String?
  accessToken  String?
  tokenType    String?
  scope        String?
  expiryDate   DateTime?
  rawTokens    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([googleUserId])
  @@index([email])
}

model GoogleOAuthState {
  id          String    @id @default(cuid())
  state       String    @unique
  userId      String
  redirectUri String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  consumedAt  DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PaypalAccount {
  id            String    @id @default(cuid())
  userId        String    @unique
  paypalPayerId String?
  merchantId    String?
  businessName  String?
  email         String?
  accessToken   String?
  refreshToken  String?
  tokenType     String?
  scope         String?
  expiresAt     DateTime?
  lastSyncedAt  DateTime?
  rawTokens     Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([paypalPayerId])
  @@index([merchantId])
  @@index([email])
}

model PaypalOAuthState {
  id          String    @id @default(cuid())
  state       String    @unique
  userId      String
  redirectUri String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  consumedAt  DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PaypalTransaction {
  id              String    @id @default(cuid())
  userId          String
  clientId        String?
  transactionId   String
  status          String?
  eventCode       String?
  referenceId     String?
  invoiceId       String?
  customField     String?
  transactionDate DateTime?
  updatedDate     DateTime?
  currency        String?
  grossAmount     Decimal?  @db.Decimal(12, 2)
  feeAmount       Decimal?  @db.Decimal(12, 2)
  netAmount       Decimal?  @db.Decimal(12, 2)
  payerEmail      String?
  payerName       String?
  payerId         String?
  rawPayload      Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  client          Client?   @relation(fields: [clientId], references: [id])
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, transactionId])
  @@index([clientId])
  @@index([payerEmail])
  @@index([transactionDate])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  sellerId  String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  seller    Seller    @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([expiresAt])
}

enum ClientStatus {
  NEW
  ACTIVE
  INACTIVE
  VIP
  LOST
}

enum LeadStage {
  NOVO         @map("Novo")
  AGENDOU_CALL @map("Agendou uma call")
  ENTROU_CALL  @map("Entrou na call")
  COMPROU      @map("Comprou")
  NO_SHOW      @map("Não compareceu")
}

enum AppointmentStatus {
  AGENDADA @map("Agendada")
  REMARCADO @map("Remarcado")
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum BotStatus {
  ATIVO
  PAUSADO
  TRAVADO
}

enum WeekDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum WhatsappMessageStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

enum WhatsappMessageDirection {
  INBOUND
  OUTBOUND
}

model WhatsappMessage {
  id        String   @id @default(cuid())
  userId    String
  
  // IDs e Metadados Básicos
  wamid     String   @unique
  remoteJid String
  remoteJidAlt String?
  phoneRaw  String?  // Normalized phone number
  fromMe    Boolean
  direction WhatsappMessageDirection?
  pushName  String?
  sender    String?
  participant String?
  addressingMode String?
  timestamp DateTime
  senderTimestamp BigInt? // Usando BigInt para timestamp unix preciso ou Int se for segundos
  recipientTimestamp BigInt?
  status    String?
  deliveryStatus WhatsappMessageStatus?

  // Conteúdo
  messageType  String?
  conversation String? @db.Text
  mediaUrl     String? @db.Text
  caption      String?
  intent       String? // alopecia | queda | preco | agenda | curiosidade
  
  // Enriquecimento de Dados (CRM) - Para envio ao Meta CAPI
  eventName       String? // Lead, Schedule, QualifiedLead, Purchase, NoShow
  hashedEmail     String? // SHA256 do email (em)
  hashedPhone     String? // SHA256 do phoneRaw (ph)
  hashedFirstName String? // SHA256 do primeiro nome (fn)
  hashedLastName  String? // SHA256 do sobrenome (ln)
  externalId      String? // ID externo do usuário (external_id)
  leadId          String?
  
  // Custom Data (Meta CAPI)
  contentName      String? // Ex: "Call Avaliação"
  contentCategory  String? // Ex: "High Ticket Service"
  leadStage        String? // Ex: "Agendou uma call"
  messagingChannel String? @default("WhatsApp")
  originPlatform   String? @default("WhatsApp")
  hasCall          Boolean @default(false)
  attendedCall     Boolean @default(false)
  converted        Boolean @default(false)

  // Atribuição de Anúncios (Click-to-WhatsApp)
  isAd            Boolean  @default(false)
  adTitle         String?
  adBody          String?
  adMediaType     Int?
  adThumbnailUrl  String? @db.Text
  adOriginalImageUrl String? @db.Text
  adSourceType    String?
  adSourceId      String?
  adSourceUrl     String? @db.Text
  ctwaClid        String? @db.Text // Click ID (Crítico)
  ref             String?
  sourceApp       String?
  deviceSource    String?
  instance        String?
  instanceId      String?
  slotId          String?

  // Conversão
  conversionSource           String?
  entryPointConversionSource String?
  entryPointConversionApp    String?
  entryPointConversionExternalSource String?
  entryPointConversionExternalMedium String?
  ctwaSignals                String?
  adRef                      String?

  // Infra / rastreabilidade (substitui necessidade do rawJson no futuro)
  destination   String? @db.Text
  serverUrl     String? @db.Text
  executionMode String?
  receivedAt    DateTime?
  eventType     String?

  // Flags e Metadata Adicionais
  containsAutoReply           Boolean? @default(false)
  renderLargerThumbnail       Boolean? @default(false)
  showAdAttribution           Boolean? @default(false)
  wtwaAdFormat                Boolean? @default(false)
  automatedGreetingMessageShown Boolean? @default(false)
  greetingMessageBody         String?  @db.Text

  // Payload Completo (Segurança)
  rawJson   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead Lead? @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, phoneRaw])
  @@index([userId, phoneRaw, timestamp])
  @@index([userId, phoneRaw, updatedAt])
  @@index([remoteJid])
  @@index([timestamp])
  @@index([createdAt])
  @@index([ctwaClid])
  @@index([slotId])
  @@index([leadId])
  @@map("whatsapp_messages")
}
